<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carnet Plantes Collaboratif</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      background: linear-gradient(120deg,#f7faf7 70%,#d6eedc 100%);
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #25422a;
      margin: 0; padding: 0;
    }
    header {
      background: #92cfa3;
      padding: 22px 12px 14px 12px;
      border-radius: 0 0 32px 32px;
      box-shadow: 0 2px 16px #aadbb063;
      text-align: center;
      margin-bottom: 22px;
    }
    h1 {
      margin: 0;
      font-size: 2.2em;
      letter-spacing: 1px;
    }
    #main {
      max-width: 540px;
      margin: 0 auto;
      padding: 12px;
    }
    .form-section {
      background: #e8f5e1;
      border-radius: 16px;
      margin-bottom: 32px;
      padding: 18px 14px;
      box-shadow: 0 1px 6px #b2bfa8a8;
    }
    .form-section h2 {margin-top:0;}
    input, textarea {
      width: 98%;
      padding: 8px; margin: 7px 0 16px 0;
      border-radius: 7px; border: 1px solid #bdddb8;
      font-size: 1em;
      font-family: inherit;
      background: #fafdfe;
      box-sizing: border-box;
    }
    .btn {
      background: #6dbd7a;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      margin: 0 10px 0 0;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 1px 6px #8fc08533;
      transition: background .2s;
    }
    .btn:hover { background: #528b5c; }
    .plante-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 3px 12px #cde1c04a;
      margin-bottom: 26px;
      padding: 18px 18px 8px 18px;
      position: relative;
      transition: box-shadow 0.1s;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .plante-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      width: 100%;
    }
    .plante-title {
      font-weight: bold;
      font-size: 1.2em;
    }
    .dates {
      font-size: 0.97em;
      color: #528b5c;
      margin-bottom: 5px;
      margin-top: 6px;
    }
    .notes { margin-top: 8px; color: #34643c; }
    .card-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .edit-form {
      background: #e2f3eb;
      border-radius: 13px;
      margin: 16px 0 0 0;
      padding: 10px 13px 7px 13px;
      box-shadow: 0 1px 4px #b2bfa866;
    }
    .delete-btn {
      background: #f16868;
      color: #fff;
      margin-left: 5px;
    }
    .delete-btn:hover {background:#be3030;}
    .plante-checkbox {
      margin: 0 8px 0 0;
      accent-color: #6dbd7a;
      width: 20px; height: 20px;
      transform: translateY(5px);
    }
    .select-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #d6eedc;
      padding: 9px 12px 7px 12px;
      border-radius: 0 0 18px 18px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px #bdddb899;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: flex-start;
      font-size: 1.15em;
    }
    .select-bar .btn {margin:0;}
    @media (max-width: 600px) {
      #main {padding: 3px;}
      .plante-card, .form-section {padding: 9px;}
    }
  </style>
</head>
<body>
  <header>
    <h1>üå± Carnet Plantes</h1>
    <div style="font-size:1.1em; color:#305c32; margin-top:6px;">Ajoute, modifie, supprime, s√©lectionne et arrose plusieurs plantes en 1 clic‚ÄØ!</div>
  </header>
  <div id="main">
    <div class="form-section" id="addFormSection">
      <h2>Ajouter une plante</h2>
      <form id="addPlanteForm">
        <input id="planteNom" placeholder="Nom de la plante" required maxlength="80"><br>
        <textarea id="planteNotes" placeholder="Notes, √©volution, besoins..." maxlength="300"></textarea><br>
        <label>Date d‚Äôarrosage : <input type="date" id="dateArrosage"></label><br>
        <label>Date rempotage : <input type="date" id="dateRempotage"></label><br>
        <button type="submit" class="btn">Ajouter</button>
      </form>
    </div>
    <div id="selectBar" style="display:none"></div>
    <div id="plantesList"></div>
  </div>

  <script>
    // ---- CONFIG SUPABASE ----
    const supabaseUrl = "https://jooyigpbgyzqldnwldmd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvb3lpZ3BiZ3l6cWxkbndsZG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MzgxODQsImV4cCI6MjA2ODAxNDE4NH0.OAGlTtJ9k0IzzET95PODjrFzFR-q6Zhv71IvJeXetQQ";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let plantes = [];
    let editIndex = null; // Pour savoir quelle carte est en √©dition
    let selectedPlantes = new Set();

    // ---- AFFICHAGE ----
    function renderSelectBar() {
      const bar = document.getElementById('selectBar');
      if (selectedPlantes.size === 0) {
        bar.style.display = "none";
        bar.innerHTML = "";
        return;
      }
      bar.style.display = "flex";
      bar.innerHTML = `<span>${selectedPlantes.size} plante(s) s√©lectionn√©e(s)</span>
        <button class="btn" onclick="arroserSelection()">üíß Arroser aujourd‚Äôhui</button>
        <button class="btn delete-btn" onclick="clearSelection()">Annuler la s√©lection</button>`;
    }

    function formatDate(d) {
      if (!d) return "";
      const date = new Date(d);
      if (isNaN(date)) return "";
      return date.toLocaleDateString();
    }

    function renderPlantes() {
      const list = document.getElementById('plantesList');
      list.innerHTML = "";
      if (plantes.length === 0) {
        list.innerHTML = "<div style='margin-top:32px;color:#7fc17f;text-align:center'>Aucune plante pour l‚Äôinstant.<br>Ajoute ta premi√®re plante‚ÄØ!</div>";
        return;
      }
      plantes.forEach((plante, idx) => {
        // Edition ?
        if (editIndex === idx) {
          list.innerHTML += `
          <div class="plante-card">
            <div class="plante-header">
              <span class="plante-title">üìù Modifier ${plante.nom}</span>
            </div>
            <form class="edit-form" onsubmit="return saveEdit(event,${plante.id},${idx})">
              <label>Nom : <input id="editNom${plante.id}" value="${plante.nom||''}" maxlength="80" required></label><br>
              <label>Notes :<br><textarea id="editNotes${plante.id}" maxlength="300">${plante.notes||''}</textarea></label><br>
              <label>Date arrosage : <input type="date" id="editArrosage${plante.id}" value="${plante.date_arrosage ? plante.date_arrosage.split('T')[0] : ''}"></label><br>
              <label>Date rempotage : <input type="date" id="editRempotage${plante.id}" value="${plante.date_rempotage ? plante.date_rempotage.split('T')[0] : ''}"></label><br>
              <button class="btn" type="submit">Sauvegarder</button>
              <button class="btn" type="button" onclick="cancelEdit()">Annuler</button>
            </form>
          </div>`;
        } else {
          list.innerHTML += `
          <div class="plante-card">
            <input type="checkbox" class="plante-checkbox" id="checkbox${plante.id}" data-idx="${idx}" ${selectedPlantes.has(plante.id) ? 'checked' : ''} onclick="togglePlanteSelect(${plante.id})">
            <div style="flex:1">
              <div class="plante-header">
                <span class="plante-title">${plante.nom ? "üåø "+plante.nom : "Plante"}</span>
                <div>
                  <button class="btn" onclick="editPlante(${idx})">Modifier</button>
                  <button class="btn delete-btn" onclick="deletePlante(${plante.id})">Supprimer</button>
                </div>
              </div>
              <div class="dates">
                Ajout√©e le‚ÄØ: ${formatDate(plante.date_ajout)}
                ${plante.date_arrosage ? `<br>Dernier arrosage : <b>${formatDate(plante.date_arrosage)}</b>` : ""}
                ${plante.date_rempotage ? `<br>Dernier rempotage : <b>${formatDate(plante.date_rempotage)}</b>` : ""}
              </div>
              <div class="notes">${plante.notes ? plante.notes : ""}</div>
            </div>
          </div>
        `;
        }
      });
      renderSelectBar();
    }

    // ---- S√âLECTION ----
    window.togglePlanteSelect = function(id) {
      if (selectedPlantes.has(id)) selectedPlantes.delete(id);
      else selectedPlantes.add(id);
      renderPlantes();
    }
    window.clearSelection = function() {
      selectedPlantes.clear();
      renderPlantes();
    }

    // ---- ARROSAGE GROUPE ----
    window.arroserSelection = async function() {
      if (selectedPlantes.size === 0) return;
      if (!confirm("Mettre √† jour la date d‚Äôarrosage de toutes les plantes s√©lectionn√©es √† aujourd‚Äôhui‚ÄØ?")) return;
      const ids = Array.from(selectedPlantes);
      const today = new Date().toISOString();
      const { error } = await supabase
        .from('plantes')
        .update({ date_arrosage: today })
        .in('id', ids);
      if (error) { alert("Erreur lors de l‚Äôarrosage group√© : " + error.message); return; }
      selectedPlantes.clear();
      await loadData();
    }

    // ----- AJOUT -----
    document.getElementById('addPlanteForm').onsubmit = async function(e) {
      e.preventDefault();
      const nom = document.getElementById('planteNom').value;
      const notes = document.getElementById('planteNotes').value;
      const date_ajout = new Date();
      const date_arrosage = document.getElementById('dateArrosage').value ? new Date(document.getElementById('dateArrosage').value) : null;
      const date_rempotage = document.getElementById('dateRempotage').value ? new Date(document.getElementById('dateRempotage').value) : null;
      const { error } = await supabase
        .from('plantes')
        .insert([{ nom, notes, date_ajout, date_arrosage, date_rempotage }]);
      if (error) { alert("Erreur ajout plante : " + error.message); return; }
      await loadData();
      document.getElementById('addPlanteForm').reset();
    };

    // ---- SUPPRIMER ----
    async function deletePlante(id) {
      if (!confirm("Supprimer cette plante‚ÄØ? Cette action est d√©finitive.")) return;
      await supabase.from('plantes').delete().eq('id', id);
      await loadData();
    }

    // ---- √âDITION ----
    window.editPlante = function(idx) {
      editIndex = idx;
      renderPlantes();
      setTimeout(()=>{window.scrollTo({top:0,left:0,behavior:'smooth'});},200);
    }
    window.cancelEdit = function() {
      editIndex = null;
      renderPlantes();
    }
    window.saveEdit = async function(e, id, idx) {
      e.preventDefault();
      const nom = document.getElementById('editNom'+id).value;
      const notes = document.getElementById('editNotes'+id).value;
      const date_arrosage = document.getElementById('editArrosage'+id).value;
      const date_rempotage = document.getElementById('editRempotage'+id).value;
      const { error } = await supabase
        .from('plantes')
        .update({
          nom, notes,
          date_arrosage: date_arrosage||null,
          date_rempotage: date_rempotage||null
        }).eq('id', id);
      if (error) { alert("Erreur modif : " + error.message); return; }
      editIndex = null;
      await loadData();
    }

    // ---- SYNCHRO TEMPS R√âEL
    async function loadData() {
      let { data: p, error } = await supabase
        .from('plantes')
        .select('*')
        .order('id', { ascending: false });
      if (error) {
        document.getElementById('plantesList').innerHTML = `<div style="color:red">Erreur : ${error.message}</div>`;
        return;
      }
      plantes = p || [];
      renderPlantes();
    }
    supabase.channel('realtime-plantes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'plantes' }, payload => loadData())
      .subscribe();

    // ---- INIT
    loadData();
  </script>
</body>
</html>
