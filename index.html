<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carnet Plantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Nunito', sans-serif;
      margin: 0; padding: 0;
      background: #f6fcf6;
    }
    header {
      background: #51b86c;
      color: white;
      padding: 1.5rem 0 1rem 0;
      text-align: center;
      border-radius: 0 0 2rem 2rem;
      margin-bottom: 1rem;
    }
    .container {
      max-width: 550px;
      margin: auto;
      padding: 1rem;
    }
    .plant-card {
      display: flex;
      align-items: center;
      background: #e8fbe4;
      border-radius: 1rem;
      padding: 0.8rem;
      margin-bottom: 1.2rem;
      box-shadow: 0 2px 8px #0001;
      transition: box-shadow .2s;
      cursor: pointer;
    }
    .plant-card:hover { box-shadow: 0 4px 12px #0002; }
    .plant-photo-thumb {
      width: 60px; height: 60px; object-fit: cover;
      border-radius: 1rem; background: #fff;
      margin-right: 1rem;
      border: 1.5px solid #b4dfbe;
    }
    .plant-main {
      flex: 1;
    }
    .btn-add, .btn-back, .btn-delete {
      background: #51b86c;
      color: white;
      border: none;
      border-radius: 2rem;
      padding: 0.6rem 1.4rem;
      font-size: 1rem;
      margin: 0.3rem 0.4rem;
      cursor: pointer;
      transition: background .2s;
    }
    .btn-add:hover { background: #388e4e; }
    .btn-back { background: #dedede; color: #168942; }
    .btn-delete { background: #eb5b5b; }
    .gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }
    .gallery-img-block {
      width: 120px;
      display: flex; flex-direction: column; align-items: center;
      background: #f6f9f6;
      border-radius: 1rem; box-shadow: 0 1px 3px #0001;
      padding: 0.5rem 0.4rem;
      margin-bottom: 0.5rem;
    }
    .gallery-img {
      width: 95px; height: 95px; object-fit: cover;
      border-radius: 0.8rem;
      cursor: pointer;
      margin-bottom: 0.3rem;
      border: 1px solid #bde3ca;
      transition: box-shadow .2s;
    }
    .gallery-img:hover { box-shadow: 0 4px 8px #b2ffd8aa; }
    .gallery-caption { font-size: .90em; color: #334; margin-bottom: 2px; text-align: center;}
    .gallery-date { font-size: .80em; color: #888; margin-bottom: 4px; text-align: center;}
    .gallery-delete-btn {
      background: #eb5b5b; color: white; border: none; border-radius: 100px; cursor: pointer;
      font-size: 1em; margin-bottom: 3px; padding: 2px 9px;
      align-self: flex-end;
    }
    @media (max-width: 650px) {
      .container { padding: 0.2rem; }
      .gallery-img-block { width: 45vw; min-width: 80px;}
      .gallery-img { width: 39vw; height: 39vw; }
    }
    .modal-bg {
      display: none; position: fixed; z-index: 40; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); align-items: center; justify-content: center;
    }
    .modal-bg.active { display: flex; }
    .modal-img-content {
      background: white; border-radius: 1rem; padding: 1.2rem; text-align: center; max-width: 95vw; max-height: 90vh;
      display: flex; flex-direction: column; align-items: center;
    }
    .modal-img {
      max-width: 65vw; max-height: 60vh; border-radius: 1rem; margin-bottom: 1rem;
    }
    .modal-caption { font-size: 1em; margin-bottom: 0.4rem; }
    .modal-date { color: #888; font-size: .93em; }
    .close-modal-btn {
      background: #eb5b5b; color: white; border: none; border-radius: 100px; cursor: pointer;
      font-size: 1.2em; padding: 3px 15px; position: absolute; top: 16px; right: 32px;
    }
    .form-section {
      background: #fff; border-radius: 1rem; box-shadow: 0 1px 8px #0001; padding: 1.5rem; margin-bottom: 1.4rem;
    }
    .form-field { margin-bottom: 1rem; width: 100%; }
    label { font-weight: bold; }
    input, textarea {
      width: 100%; padding: 0.5rem; border-radius: 0.7rem; border: 1px solid #b4dfbe;
      font-family: 'Nunito', sans-serif; font-size: 1em; margin-top: 0.2rem;
    }
    .notes { color: #165d1b; font-size: 1em; }
    .plantes-list-title {
      margin-bottom: 0.6rem; color: #277541;
      font-size: 1.1em; font-weight: 700;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸŒ± Carnet Plantes</h1>
    <div style="font-weight:400;margin-top:.5em;font-size:1.05em;">Ajoutez vos plantes, photos, arrosages, rempotages, notesâ€¦</div>
  </header>
  <div class="container" id="app">
    <!-- Ici se gÃ©nÃ¨re toute l'app -->
  </div>

  <!-- Modal photo agrandie -->
  <div class="modal-bg" id="modalBg" onclick="closeModal()">
    <div class="modal-img-content" onclick="event.stopPropagation();">
      <button class="close-modal-btn" onclick="closeModal()">&times;</button>
      <img id="modalImg" class="modal-img" src="" alt="Photo plante">
      <div class="modal-caption" id="modalCaption"></div>
      <div class="modal-date" id="modalDate"></div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // ---- CONFIGURATION ----
    const SUPABASE_URL = 'https://jooyigpbgyzqldnwldmd.supabase.co'; // <-- remplace par ton URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvb3lpZ3BiZ3l6cWxkbndsZG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MzgxODQsImV4cCI6MjA2ODAxNDE4NH0.OAGlTtJ9k0IzzET95PODjrFzFR-q6Zhv71IvJeXetQQ'; // <-- remplace par ta clÃ©
    const BUCKET = 'plantes-photos';

    // Remplace ces valeurs â†‘ (garde-les confidentielles cÃ´tÃ© vrai projet, ici câ€™est pour Github Pages only)

    // ---- INIT ----
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- RENDER APP ----
    let plantes = [];
    let photos = [];
    let currentPlanteId = null;

    document.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
      await fetchPlantes();
      renderPlantesList();
    }

    // ---- API ----
    async function fetchPlantes() {
      let { data, error } = await supabase.from('plantes').select('*').order('date_ajout', {ascending: false});
      plantes = data || [];
    }
    async function fetchPhotos(plante_id) {
      let { data, error } = await supabase.from('photos').select('*').eq('plante_id', plante_id).order('date_ajout', {ascending: false});
      photos = data || [];
    }
    async function addPlante(obj) {
      let { data, error } = await supabase.from('plantes').insert([obj]);
      return data ? data[0] : null;
    }
    async function deletePlante(id) {
      await supabase.from('plantes').delete().eq('id', id);
    }
    async function addPhoto(plante_id, file, caption) {
      // 1. Upload dans le bucket Supabase
      const ext = file.name.split('.').pop();
      const fileName = `${plante_id}_${Date.now()}.${ext}`;
      let { data, error: errUp } = await supabase.storage.from(BUCKET).upload(fileName, file);
      if (errUp) return alert("Erreur upload photo");
      // 2. Stocker dans la table photos (url, caption, date)
      let url = supabase.storage.from(BUCKET).getPublicUrl(fileName).publicUrl;
      let { data: res, error: errInsert } = await supabase.from('photos').insert([{ plante_id, url, caption, date_ajout: new Date() }]);
      if (errInsert) return alert("Erreur DB photo");
      return res ? res[0] : null;
    }
    async function deletePhoto(photoId, url) {
      // 1. Supprime DB
      await supabase.from('photos').delete().eq('id', photoId);
      // 2. Supprime storage
      let path = url.split('/').slice(-1)[0];
      await supabase.storage.from(BUCKET).remove([path]);
    }

    // ---- UI RENDER ----
    function renderPlantesList() {
      currentPlanteId = null;
      let html = `
        <div class="form-section">
          <div class="plantes-list-title">Ajouter une plante</div>
          <form onsubmit="return handleAddPlante(event)">
            <div class="form-field"><label>Nom de la plante</label><input required id="planteNom"></div>
            <div class="form-field"><label>Photo principale</label><input type="file" id="plantePhoto"></div>
            <div class="form-field"><label>Date dernier arrosage</label><input type="date" id="dateArrosage"></div>
            <div class="form-field"><label>Date dernier rempotage</label><input type="date" id="dateRempotage"></div>
            <div class="form-field"><label>Notes</label><textarea id="planteNotes"></textarea></div>
            <button class="btn-add" type="submit">Ajouter la plante</button>
          </form>
        </div>
        <div class="plantes-list-title">Mes plantes (${plantes.length})</div>
        ${plantes.length === 0 ? "<p>Aucune plante enregistrÃ©e.</p>" : ""}
        ${plantes.map(plante => `
          <div class="plant-card" onclick="handleShowPlante(${plante.id})">
            <img class="plant-photo-thumb" src="${plante.photo_url || 'https://cdn-icons-png.flaticon.com/512/2909/2909765.png'}" alt="">
            <div class="plant-main">
              <div style="font-weight:700;font-size:1.18em">${plante.nom}</div>
              <div style="color:#34814e;font-size:0.98em">
                ðŸ’§ ${plante.date_arrosage ? 'ArrosÃ©e le ' + plante.date_arrosage : 'Pas encore arrosÃ©e'}<br>
                ðŸŒ± ${plante.date_rempotage ? 'RempotÃ©e le ' + plante.date_rempotage : 'Jamais rempotÃ©e'}
              </div>
              <div style="font-size:0.95em;color:#444">${plante.notes ? plante.notes : ''}</div>
            </div>
          </div>
        `).join('')}
      `;
      document.getElementById('app').innerHTML = html;
    }

    async function handleAddPlante(e) {
      e.preventDefault();
      let nom = document.getElementById('planteNom').value.trim();
      let photoInput = document.getElementById('plantePhoto');
      let date_arrosage = document.getElementById('dateArrosage').value;
      let date_rempotage = document.getElementById('dateRempotage').value;
      let notes = document.getElementById('planteNotes').value;
      let obj = { nom, date_arrosage, date_rempotage, notes, date_ajout: new Date() };
      let photoUrl = '';
      // upload photo principale
      if(photoInput.files.length) {
        let file = photoInput.files[0];
        const ext = file.name.split('.').pop();
        const fileName = `main_${nom.replace(/\s/g,'_')}_${Date.now()}.${ext}`;
        let { data, error } = await supabase.storage.from(BUCKET).upload(fileName, file);
        if (!error) photoUrl = supabase.storage.from(BUCKET).getPublicUrl(fileName).publicUrl;
        obj.photo_url = photoUrl;
      }
      let newPlante = await addPlante(obj);
      await fetchPlantes();
      renderPlantesList();
    }

    async function handleShowPlante(id) {
      currentPlanteId = id;
      let plante = plantes.find(p=>p.id === id);
      await fetchPhotos(id);
      // Affiche fiche plante + galerie
      let html = `
        <button class="btn-back" onclick="initApp()">&larr; Revenir Ã  la liste</button>
        <div class="form-section">
          <div style="display:flex;align-items:center;gap:1rem;">
            <img class="plant-photo-thumb" src="${plante.photo_url || 'https://cdn-icons-png.flaticon.com/512/2909/2909765.png'}" alt="">
            <div>
              <div style="font-weight:700;font-size:1.22em">${plante.nom}</div>
              <div style="color:#277541;font-size:0.99em">
                ðŸ’§ Dernier arrosageâ€¯: <b>${plante.date_arrosage || '-'}</b><br>
                ðŸŒ± Dernier rempotageâ€¯: <b>${plante.date_rempotage || '-'}</b>
              </div>
              <div style="font-size:.97em;color:#444;margin-top:.2em">${plante.notes ? plante.notes : ''}</div>
              <button class="btn-delete" onclick="handleDeletePlante(${plante.id});event.stopPropagation();">Supprimer</button>
            </div>
          </div>
        </div>
        <div class="form-section">
          <div style="font-weight:700;font-size:1.15em;color:#277541;margin-bottom:0.7em;">Galerie photo / vidÃ©o</div>
          <form onsubmit="return handleAddPhoto(event,${plante.id})" style="margin-bottom:.8em;">
            <input type="file" required id="newPhotoFile">
            <input style="margin-top:.3em;" type="text" id="newPhotoCaption" placeholder="Description ou notes (facultatif)">
            <button class="btn-add" type="submit">Ajouter photo/vidÃ©o</button>
          </form>
          <div class="gallery">
            ${photos.length === 0 ? '<div>Aucune photo enregistrÃ©e.</div>' : photos.map(photo=>`
              <div class="gallery-img-block">
                <img class="gallery-img" src="${photo.url}" alt="" onclick="showModal('${photo.url}','${photo.caption || ''}','${photo.date_ajout ? (new Date(photo.date_ajout)).toLocaleString('fr-CA') : ''}')">
                <div class="gallery-date">${photo.date_ajout ? (new Date(photo.date_ajout)).toLocaleDateString('fr-CA') : ''}</div>
                <div class="gallery-caption">${photo.caption || ''}</div>
                <button class="gallery-delete-btn" onclick="handleDeletePhoto(${photo.id},'${photo.url}');event.stopPropagation();">&times;</button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      document.getElementById('app').innerHTML = html;
    }

    async function handleAddPhoto(e,plante_id) {
      e.preventDefault();
      let fileInput = document.getElementById('newPhotoFile');
      let caption = document.getElementById('newPhotoCaption').value;
      if(!fileInput.files.length) return false;
      await addPhoto(plante_id, fileInput.files[0], caption);
      await fetchPhotos(plante_id);
      handleShowPlante(plante_id);
      return false;
    }
    async function handleDeletePlante(id) {
      if(!confirm("Supprimer cette planteâ€¯?")) return;
      await deletePlante(id);
      await fetchPlantes();
      renderPlantesList();
    }
    async function handleDeletePhoto(id,url) {
      if(!confirm("Supprimer cette photoâ€¯?")) return;
      await deletePhoto(id,url);
      await fetchPhotos(currentPlanteId);
      handleShowPlante(currentPlanteId);
    }

    // ---- MODAL GESTION ----
    function showModal(url,caption,date) {
      document.getElementById('modalBg').classList.add('active');
      document.getElementById('modalImg').src = url;
      document.getElementById('modalCaption').textContent = caption;
      document.getElementById('modalDate').textContent = date ? `AjoutÃ©e le ${date}` : '';
    }
    function closeModal() {
      document.getElementById('modalBg').classList.remove('active');
      document.getElementById('modalImg').src = '';
      document.getElementById('modalCaption').textContent = '';
      document.getElementById('modalDate').textContent = '';
    }

    // Pour Ã©viter les conflits de scope
    window.handleAddPlante = handleAddPlante;
    window.handleShowPlante = handleShowPlante;
    window.handleAddPhoto = handleAddPhoto;
    window.handleDeletePlante = handleDeletePlante;
    window.handleDeletePhoto = handleDeletePhoto;
    window.showModal = showModal;
    window.closeModal = closeModal;
  </script>
</body>
</html>
