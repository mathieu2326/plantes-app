<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carnet Plantes Collaboratif</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      background: linear-gradient(120deg,#f7faf7 70%,#d6eedc 100%);
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #25422a;
      margin: 0; padding: 0;
    }
    header {
      background: #92cfa3;
      padding: 22px 12px 14px 12px;
      border-radius: 0 0 32px 32px;
      box-shadow: 0 2px 16px #aadbb063;
      text-align: center;
      margin-bottom: 22px;
    }
    h1 {
      margin: 0;
      font-size: 2.2em;
      letter-spacing: 1px;
    }
    #main {
      max-width: 540px;
      margin: 0 auto;
      padding: 12px;
    }
    .form-section {
      background: #e8f5e1;
      border-radius: 16px;
      margin-bottom: 32px;
      padding: 18px 14px;
      box-shadow: 0 1px 6px #b2bfa8a8;
    }
    .form-section h2 {margin-top:0;}
    input, textarea {
      width: 98%;
      padding: 8px; margin: 7px 0 16px 0;
      border-radius: 7px; border: 1px solid #bdddb8;
      font-size: 1em;
      font-family: inherit;
      background: #fafdfe;
      box-sizing: border-box;
    }
    .btn {
      background: #6dbd7a;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      margin: 0 10px 0 0;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 1px 6px #8fc08533;
      transition: background .2s;
    }
    .btn:hover { background: #528b5c; }
    .plante-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 3px 12px #cde1c04a;
      margin-bottom: 26px;
      padding: 18px 18px 8px 18px;
      position: relative;
      transition: box-shadow 0.1s;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      cursor: pointer;
    }
    .plante-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      width: 100%;
    }
    .plante-title {
      font-weight: bold;
      font-size: 1.2em;
    }
    .dates {
      font-size: 0.97em;
      color: #528b5c;
      margin-bottom: 5px;
      margin-top: 6px;
    }
    .notes { margin-top: 8px; color: #34643c; }
    .card-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .edit-form {
      background: #e2f3eb;
      border-radius: 13px;
      margin: 16px 0 0 0;
      padding: 10px 13px 7px 13px;
      box-shadow: 0 1px 4px #b2bfa866;
    }
    .delete-btn {
      background: #f16868;
      color: #fff;
      margin-left: 5px;
    }
    .delete-btn:hover {background:#be3030;}
    .plante-checkbox {
      margin: 0 8px 0 0;
      accent-color: #6dbd7a;
      width: 20px; height: 20px;
      transform: translateY(5px);
    }
    .select-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #d6eedc;
      padding: 9px 12px 7px 12px;
      border-radius: 0 0 18px 18px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px #bdddb899;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: flex-start;
      font-size: 1.15em;
    }
    .select-bar .btn {margin:0;}
    /* Galerie photo styles */
    .gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 14px 0 10px 0;
    }
    .gallery img,
    .gallery video {
      border-radius: 8px;
      width: 82px; height: 82px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid #c2e3ca;
      background: #eafaea;
    }
    .gallery .del-btn {
      display: block;
      background: #f16868;
      border-radius: 50%;
      color: #fff;
      font-weight: bold;
      border: none;
      width: 22px;
      height: 22px;
      font-size: 1.2em;
      position: absolute;
      top: -8px; right: -8px;
      z-index: 3;
      cursor: pointer;
      padding:0;
    }
    .gallery-item {
      position: relative;
      display: inline-block;
    }
    .gallery-counter {
      margin: 0 0 8px 0;
      color: #457853;
      font-size: 0.98em;
      font-weight: 500;
    }
    .fullscreen {
      position: fixed;
      z-index: 99;
      top:0; left:0; width:100vw; height:100vh;
      background: rgba(34, 52, 30, 0.96);
      display:flex;align-items:center;justify-content:center;
      flex-direction:column;
    }
    .fullscreen img, .fullscreen video {
      max-width:92vw; max-height:82vh;
      border-radius:12px;
      box-shadow: 0 4px 24px #86a68f;
      background:#fff;
    }
    .fullscreen .btn {
      margin-top:18px;font-size:1.2em;
    }
    @media (max-width: 600px) {
      #main {padding: 3px;}
      .plante-card, .form-section {padding: 9px;}
      .gallery img, .gallery video {width:55px; height:55px;}
    }
  </style>
</head>
<body>
  <header>
    <h1>üå± Carnet Plantes</h1>
    <div style="font-size:1.1em; color:#305c32; margin-top:6px;">Ajoute, modifie, supprime, s√©lectionne, arrose, et acc√®de √† la galerie photo/vid√©o de chaque plante‚ÄØ!</div>
  </header>
  <div id="main">
    <div id="listePlantesView" style="display:block"></div>
    <div id="fichePlanteView" style="display:none"></div>
  </div>
  <div id="fullscreen" style="display:none"></div>
  <script>
    // ---- CONFIG SUPABASE ----
    const supabaseUrl = "https://jooyigpbgyzqldnwldmd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvb3lpZ3BiZ3l6cWxkbndsZG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MzgxODQsImV4cCI6MjA2ODAxNDE4NH0.OAGlTtJ9k0IzzET95PODjrFzFR-q6Zhv71IvJeXetQQ";
    const bucketName = "plantes-photos";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let plantes = [];
    let editIndex = null;
    let selectedPlantes = new Set();
    let currentPlante = null;
    let currentPhotos = [];
    let currentPhotoType = [];
    let loadingGallery = false;

    // ========== AFFICHAGE ==========
    function formatDate(d) {
      if (!d) return "";
      const date = new Date(d);
      if (isNaN(date)) return "";
      return date.toLocaleDateString();
    }

    // ==== VUE LISTE DE TOUTES LES PLANTES ====
    function renderListePlantes() {
      document.getElementById('fichePlanteView').style.display = "none";
      const cont = document.getElementById('listePlantesView');
      cont.style.display = "block";
      let html = `<div class="form-section" id="addFormSection">
      <h2>Ajouter une plante</h2>
      <form id="addPlanteForm">
        <input id="planteNom" placeholder="Nom de la plante" required maxlength="80"><br>
        <textarea id="planteNotes" placeholder="Notes, √©volution, besoins..." maxlength="300"></textarea><br>
        <label>Date d‚Äôarrosage : <input type="date" id="dateArrosage"></label><br>
        <label>Date rempotage : <input type="date" id="dateRempotage"></label><br>
        <button type="submit" class="btn">Ajouter</button>
      </form></div>
      <div id="selectBar" style="display:${selectedPlantes.size ? 'flex':'none'};margin-bottom:18px"></div>
      <div id="plantesList"></div>`;
      cont.innerHTML = html;
      renderSelectBar();
      renderPlantes();
      document.getElementById('addPlanteForm').onsubmit = addPlante;
    }

    function renderSelectBar() {
      const bar = document.getElementById('selectBar');
      if (!bar) return;
      if (selectedPlantes.size === 0) {
        bar.style.display = "none";
        bar.innerHTML = "";
        return;
      }
      bar.style.display = "flex";
      bar.innerHTML = `<span>${selectedPlantes.size} plante(s) s√©lectionn√©e(s)</span>
        <button class="btn" onclick="arroserSelection()">üíß Arroser aujourd‚Äôhui</button>
        <button class="btn delete-btn" onclick="clearSelection()">Annuler la s√©lection</button>`;
    }

    function renderPlantes() {
      const list = document.getElementById('plantesList');
      if (!list) return;
      list.innerHTML = "";
      if (plantes.length === 0) {
        list.innerHTML = "<div style='margin-top:32px;color:#7fc17f;text-align:center'>Aucune plante pour l‚Äôinstant.<br>Ajoute ta premi√®re plante‚ÄØ!</div>";
        return;
      }
      plantes.forEach((plante, idx) => {
        if (editIndex === idx) {
          list.innerHTML += `
          <div class="plante-card" style="cursor:auto">
            <div class="plante-header">
              <span class="plante-title">üìù Modifier ${plante.nom}</span>
            </div>
            <form class="edit-form" onsubmit="return saveEdit(event,${plante.id},${idx})">
              <label>Nom : <input id="editNom${plante.id}" value="${plante.nom||''}" maxlength="80" required></label><br>
              <label>Notes :<br><textarea id="editNotes${plante.id}" maxlength="300">${plante.notes||''}</textarea></label><br>
              <label>Date arrosage : <input type="date" id="editArrosage${plante.id}" value="${plante.date_arrosage ? plante.date_arrosage.split('T')[0] : ''}"></label><br>
              <label>Date rempotage : <input type="date" id="editRempotage${plante.id}" value="${plante.date_rempotage ? plante.date_rempotage.split('T')[0] : ''}"></label><br>
              <button class="btn" type="submit">Sauvegarder</button>
              <button class="btn" type="button" onclick="cancelEdit()">Annuler</button>
            </form>
          </div>`;
        } else {
          list.innerHTML += `
          <div class="plante-card" onclick="openFiche(${plante.id})">
            <input type="checkbox" class="plante-checkbox" id="checkbox${plante.id}" data-idx="${idx}" ${selectedPlantes.has(plante.id) ? 'checked' : ''} onclick="event.stopPropagation();togglePlanteSelect(${plante.id})">
            <div style="flex:1">
              <div class="plante-header">
                <span class="plante-title">${plante.nom ? "üåø "+plante.nom : "Plante"}</span>
                <div>
                  <button class="btn" onclick="event.stopPropagation();editPlante(${idx})">Modifier</button>
                  <button class="btn delete-btn" onclick="event.stopPropagation();deletePlante(${plante.id})">Supprimer</button>
                </div>
              </div>
              <div class="dates">
                Ajout√©e le‚ÄØ: ${formatDate(plante.date_ajout)}
                ${plante.date_arrosage ? `<br>Dernier arrosage : <b>${formatDate(plante.date_arrosage)}</b>` : ""}
                ${plante.date_rempotage ? `<br>Dernier rempotage : <b>${formatDate(plante.date_rempotage)}</b>` : ""}
              </div>
              <div class="notes">${plante.notes ? plante.notes : ""}</div>
            </div>
          </div>
        `;
        }
      });
      renderSelectBar();
    }

    // ==== VUE FICHE PLANTE & GALERIE ====
    async function openFiche(id) {
      if (editIndex !== null) return; // Ne pas ouvrir fiche si √©dition en cours
      currentPlante = plantes.find(p => p.id === id);
      await loadGalleryPhotos();
      document.getElementById('listePlantesView').style.display = "none";
      renderFichePlante();
      document.getElementById('fichePlanteView').style.display = "block";
    }

    function renderFichePlante() {
      const cont = document.getElementById('fichePlanteView');
      if (!currentPlante) { cont.innerHTML = "Erreur"; return; }
      let html = `<button class="btn" onclick="goBackListe()">‚¨Ö Revenir √† la liste</button><br><br>
        <div class="form-section">
          <h2>üåø ${currentPlante.nom}</h2>
          <div class="dates">
            Ajout√©e le‚ÄØ: ${formatDate(currentPlante.date_ajout)}
            ${currentPlante.date_arrosage ? `<br>Dernier arrosage : <b>${formatDate(currentPlante.date_arrosage)}</b>` : ""}
            ${currentPlante.date_rempotage ? `<br>Dernier rempotage : <b>${formatDate(currentPlante.date_rempotage)}</b>` : ""}
          </div>
          <div class="notes">${currentPlante.notes ? currentPlante.notes : ""}</div>
        </div>
        <div class="form-section">
          <h2>Galerie photo / vid√©o</h2>
          <div class="gallery-counter">${currentPhotos.length} fichier(s)</div>
          <form onsubmit="return false;">
            <input type="file" id="fileInput" accept="image/*,video/*" multiple style="margin-bottom:7px">
            <button class="btn" type="button" onclick="uploadFiles()">Ajouter photo/vid√©o</button>
          </form>
          <div style="color:#be3030;font-size:0.99em;margin:5px 0" id="uploadError"></div>
          <div class="gallery" id="galleryCont">`;
      if (loadingGallery) {
        html += `<div style="color:#6dbd7a">Chargement...</div>`;
      } else if (currentPhotos.length === 0) {
        html += `<div style="color:#97a292">Aucune photo/vid√©o enregistr√©e pour cette plante.</div>`;
      } else {
        currentPhotos.forEach(photo => {
          let ext = photo.url.split('.').pop().toLowerCase();
          let isVideo = ext === "mp4" || ext === "webm" || ext === "mov" || ext === "avi";
          html += `<div class="gallery-item">
            ${isVideo ? `<video src="${photo.url}" controls onclick="showFullscreen(event,'${photo.url}',true)"></video>` 
              : `<img src="${photo.url}" onclick="showFullscreen(event,'${photo.url}',false)">`}
            <button class="del-btn" onclick="deletePhoto('${photo.id}','${photo.storage_key}');event.stopPropagation()">√ó</button>
          </div>`;
        });
      }
      html += `</div></div>`;
      cont.innerHTML = html;
    }

    function goBackListe() {
      document.getElementById('fichePlanteView').style.display = "none";
      currentPlante = null;
      renderListePlantes();
    }

    // ========= GALERIE (upload, afficher, suppression) =============

    async function loadGalleryPhotos() {
      loadingGallery = true;
      renderFichePlante();
      let { data, error } = await supabase
        .from('photos')
        .select('*')
        .eq('plante_id', currentPlante.id)
        .order('date_ajout', { ascending: false });
      currentPhotos = data || [];
      loadingGallery = false;
    }

    window.uploadFiles = async function() {
      let files = document.getElementById('fileInput').files;
      let errorDiv = document.getElementById('uploadError');
      errorDiv.textContent = "";
      if (!files.length) { errorDiv.textContent = "Aucun fichier s√©lectionn√©."; return; }
      const maxSize = 15 * 1024 * 1024; // 15 Mo
      for (let i = 0; i < files.length; i++) {
        let file = files[i];
        if (file.size > maxSize) {
          errorDiv.textContent = `Le fichier "${file.name}" est trop lourd (max 15 Mo).`;
          return;
        }
        let ext = file.name.split('.').pop().toLowerCase();
        let path = `${currentPlante.id}/${Date.now()}_${file.name}`;
        let { data, error } = await supabase.storage.from(bucketName).upload(path, file, { upsert: false });
        if (error) { errorDiv.textContent = error.message; return; }
        let publicURL = supabase.storage.from(bucketName).getPublicUrl(path).data.publicUrl;
        let { error: err2 } = await supabase.from('photos').insert([{
          plante_id: currentPlante.id,
          url: publicURL,
          storage_key: path,
          date_ajout: new Date()
        }]);
        if (err2) { errorDiv.textContent = err2.message; return; }
      }
      document.getElementById('fileInput').value = "";
      await loadGalleryPhotos();
      renderFichePlante();
    }

    window.deletePhoto = async function(photo_id, storage_key) {
      if (!confirm("Supprimer cette photo/vid√©o‚ÄØ?")) return;
      await supabase.storage.from(bucketName).remove([storage_key]);
      await supabase.from('photos').delete().eq('id', photo_id);
      await loadGalleryPhotos();
      renderFichePlante();
    }

    window.showFullscreen = function(event, url, isVideo) {
      event.stopPropagation();
      let fs = document.getElementById('fullscreen');
      fs.innerHTML = isVideo
        ? `<video src="${url}" controls autoplay style="background:#000"></video>`
        : `<img src="${url}">`;
      fs.innerHTML += `<button class="btn" onclick="closeFullscreen()">Fermer</button>`;
      fs.style.display = "flex";
      fs.onclick = closeFullscreen;
    }
    window.closeFullscreen = function() {
      let fs = document.getElementById('fullscreen');
      fs.style.display = "none";
      fs.innerHTML = "";
    }

    // ========== LOGIQUE PLANTES (ajout/√©dition/supp/s√©lection/arrosage) ============

    async function loadData() {
      let { data: p, error } = await supabase
        .from('plantes')
        .select('*')
        .order('id', { ascending: false });
      if (error) {
        document.getElementById('listePlantesView').innerHTML = `<div style="color:red">Erreur : ${error.message}</div>`;
        return;
      }
      plantes = p || [];
      renderListePlantes();
    }

    async function addPlante(e) {
      e.preventDefault();
      const nom = document.getElementById('planteNom').value;
      const notes = document.getElementById('planteNotes').value;
      const date_ajout = new Date();
      const date_arrosage = document.getElementById('dateArrosage').value ? new Date(document.getElementById('dateArrosage').value) : null;
      const date_rempotage = document.getElementById('dateRempotage').value ? new Date(document.getElementById('dateRempotage').value) : null;
      const { error } = await supabase
        .from('plantes')
        .insert([{ nom, notes, date_ajout, date_arrosage, date_rempotage }]);
      if (error) { alert("Erreur ajout plante : " + error.message); return; }
      await loadData();
      document.getElementById('addPlanteForm').reset();
    }

    async function deletePlante(id) {
      if (!confirm("Supprimer cette plante‚ÄØ? Cette action est d√©finitive.")) return;
      await supabase.from('plantes').delete().eq('id', id);
      await supabase.from('photos').delete().eq('plante_id', id);
      await loadData();
    }

    window.editPlante = function(idx) {
      editIndex = idx;
      renderPlantes();
      setTimeout(()=>{window.scrollTo({top:0,left:0,behavior:'smooth'});},200);
    }
    window.cancelEdit = function() {
      editIndex = null;
      renderPlantes();
    }
    window.saveEdit = async function(e, id, idx) {
      e.preventDefault();
      const nom = document.getElementById('editNom'+id).value;
      const notes = document.getElementById('editNotes'+id).value;
      const date_arrosage = document.getElementById('editArrosage'+id).value;
      const date_rempotage = document.getElementById('editRempotage'+id).value;
      const { error } = await supabase
        .from('plantes')
        .update({
          nom, notes,
          date_arrosage: date_arrosage||null,
          date_rempotage: date_rempotage||null
        }).eq('id', id);
      if (error) { alert("Erreur modif : " + error.message); return; }
      editIndex = null;
      await loadData();
    }

    window.togglePlanteSelect = function(id) {
      if (selectedPlantes.has(id)) selectedPlantes.delete(id);
      else selectedPlantes.add(id);
      renderPlantes();
    }
    window.clearSelection = function() {
      selectedPlantes.clear();
      renderPlantes();
    }
    window.arroserSelection = async function() {
      if (selectedPlantes.size === 0) return;
      if (!confirm("Mettre √† jour la date d‚Äôarrosage de toutes les plantes s√©lectionn√©es √† aujourd‚Äôhui‚ÄØ?")) return;
      const ids = Array.from(selectedPlantes);
      const today = new Date().toISOString();
      const { error } = await supabase
        .from('plantes')
        .update({ date_arrosage: today })
        .in('id', ids);
      if (error) { alert("Erreur lors de l‚Äôarrosage group√© : " + error.message); return; }
      selectedPlantes.clear();
      await loadData();
    }

    // ---- SYNCHRO TEMPS R√âEL
    supabase.channel('realtime-plantes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'plantes' }, payload => loadData())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'photos' }, payload => {
        // Si fiche plante affich√©e, recharge sa galerie instantan√©ment
        if (currentPlante) loadGalleryPhotos().then(renderFichePlante);
      })
      .subscribe();

    // ---- INIT
    loadData();
  </script>
</body>
</html>
